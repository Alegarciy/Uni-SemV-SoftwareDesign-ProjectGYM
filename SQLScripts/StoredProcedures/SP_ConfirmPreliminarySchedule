-- Create a new stored procedure called 'SP_ConfirmPreliminarySchedule' in schema 'dbo'
-- Drop the stored procedure if it already exists
IF EXISTS (
SELECT *
    FROM INFORMATION_SCHEMA.ROUTINES
WHERE SPECIFIC_SCHEMA = N'dbo'
    AND SPECIFIC_NAME = N'SP_ConfirmPreliminarySchedule'
    AND ROUTINE_TYPE = N'PROCEDURE'
)
DROP PROCEDURE dbo.SP_ConfirmPreliminarySchedule
GO
-- Create the stored procedure in the specified schema
CREATE PROCEDURE dbo.SP_ConfirmPreliminarySchedule
    @pMonthToConfirm        INT,
    @pYearOfMonthToConfirm  INT
AS
BEGIN
    BEGIN TRY

        -- DECLARATIONS

        -- VARIABLES

        DECLARE @MonthsInitialDate DATE

        -- TABLE VARIABLES
        DECLARE @MonthsPreliminarySessions TABLE
            (
                ID              INT, 
                [WeekDay]       INT, 
                InstructorId    INT
            )
        DECLARE @ConfirmedSessions TABLE
            (
                 
                [Date]                  INT, 
                Cancelled               BIT,
                InstructorId            INT,
                PreliminarySessionId    INT
            )


        -- ERRORS
        DECLARE @NoSessionsInMonthErrorCode INT
        DECLARE @SPErrorCode                INT     


        -- ERROR CODE SETS
        SET @SPErrorCode = 
            (
                SELECT
                    [error].Code
                FROM
                    dbo.Errors AS [error]
                WHERE
                    [error].[ErrorName] = 'SPError'
            )  

        SET @NoSessionsInMonthErrorCode = 
            (
                SELECT
                    [error].Code
                FROM
                    dbo.Errors AS [error]
                WHERE
                    [error].[ErrorName] = 'NoSessionsFoundError'
            )

        -- SELECTION OF THE PRELIMINARY SESSIONS THAT MATCH THE MONTH AND YEAR GIVEN

        INSERT INTO
            @MonthsPreliminarySessions
        SELECT
            preliminarySession.Id,
            preliminarySession.DiaSemana,
            preliminarySession.InstructorId
        FROM 
            dbo.SesionPreliminar AS preliminarySession
        WHERE 
                preliminarySession.Mes = @pMonthToConfirm
            AND preliminarySession.AÃ±o = @pYearOfMonthToConfirm
            AND preliminarySession.Activa = 1

        
        -- SETS THE MONTH'S INITIAL DATE BASED ON THE MONTH AND YEAR PROVIDED

        SET @MonthsInitialDate = DATEFROMPARTS(@pYearOfMonthToConfirm, @pMonthToConfirm, 1)

        -- CREATES THE CONFIRMED SESSIONS FROM THE PRELIMINARY SESSIONS (IMPORTANT PART OF THE ALGORITHM)

        RETURN 1;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK
        RETURN @SPErrorCode
    END CATCH
END

EXEC SP_ConfirmPreliminarySchedule  5, 2021;
GO